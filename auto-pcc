:put "ðŸ“¡ MikroTik Auto PCC + MAC VLAN + Optional PPPoE Server Setup ðŸš€"

# === Input Parsing ===
:local input [/user get admin comment]
:local totalLines [:toint [:pick $input 0 3]]
:local baseInterface [:pick $input 4 11]
:local enablePPPoEServer [:toint [:pick $input 12 13]]

:put "ðŸ”¢ Lines: $totalLines | ðŸ§© Base Interface: $baseInterface | ðŸ–¥ PPPoE Server: $enablePPPoEServer"

# === Create Interface List WAN ===
/interface list
:if ([:len [/interface list find name="WAN"]] = 0) do={
  add name=WAN comment="WAN Interfaces for PCC"
}
/interface list member remove [find list=WAN]  ; cleanup old members

# === Create MAC VLAN Interfaces and PPPoE Clients ===
:for i from=1 to=$totalLines do={
  /interface vlan
  add name=macvlan$i interface=$baseInterface vlan-id=$i

  /interface pppoe-client
  add name=pppoe-out$i interface=macvlan$i user="pppoeuser$i" password="password$i" use-peer-dns=no add-default-route=no disabled=no

  /interface list member
  add list=WAN interface=pppoe-out$i
}

# === Mangle Accept Rule on Top ===
/ip firewall mangle
add chain=prerouting in-interface-list=WAN action=accept place-before=0 comment="Accept WAN traffic"

# === PCC Mangle Rules ===
:for i from=1 to=$totalLines do={
  /ip firewall mangle
  add chain=prerouting in-interface=$baseInterface connection-mark=no-mark \
      action=mark-connection new-connection-mark=wan$i-conn \
      per-connection-classifier=both-addresses-and-ports:$totalLines,$i-1 passthrough=yes

  add chain=prerouting in-interface=$baseInterface connection-mark=wan$i-conn \
      action=mark-routing new-routing-mark=to-wan$i passthrough=yes
}

# === Routes ===
:for i from=1 to=$totalLines do={
  /ip route
  add gateway=pppoe-out$i routing-mark=to-wan$i check-gateway=ping
}

# === NAT Masquerade ===
/ip firewall nat
add chain=srcnat out-interface-list=WAN action=masquerade comment="Masquerade via WAN list"

# === OPTIONAL: PPPoE SERVER SETUP ===
:if ($enablePPPoEServer = 1) do={
  /ip pool
  add name=pppoe-pool ranges=192.168.77.2-192.168.77.254

  /ip address
  add address=192.168.77.1/24 interface=$baseInterface

  /ppp profile
  add name=5Mbps local-address=192.168.77.1 remote-address=pppoe-pool rate-limit=5M/5M
  add name=10Mbps local-address=192.168.77.1 remote-address=pppoe-pool rate-limit=10M/10M

  /ppp secret
  add name=user1 password=123 profile=5Mbps service=pppoe
  add name=user2 password=123 profile=10Mbps service=pppoe

  /interface pppoe-server server
  add interface=$baseInterface service-name=pppoe disabled=no

  /ip firewall address-list
  add list=pppoe-clients address=192.168.77.0/24 comment="PPPoE Pool"
  :put "âœ… PPPoE Server Setup Complete!"
}

:put "âœ… PCC Load Balancing with MAC VLAN + Interface List + Masquerade Done!"
